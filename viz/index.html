<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac EMI Simulation Configurator</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>Cardiac EMI Simulation</h1>
            <p>Configure initial excitation region and run simulation</p>
        </header>

        <!-- Main content -->
        <div class="main-content">
            <!-- 3D Viewer -->
            <div class="viewer-panel">
                <div id="viewer-container">
                    <!-- Colorbar overlay -->
                    <div id="colorbar">
                        <div class="colorbar-gradient"></div>
                        <div class="colorbar-labels">
                            <span id="colorbar-max">40 mV</span>
                            <span id="colorbar-mid">-20 mV</span>
                            <span id="colorbar-min">-80 mV</span>
                        </div>
                    </div>
                </div>
                <div class="viewer-controls">
                    <button id="reset-camera">Reset Camera</button>
                    <label>
                        <input type="checkbox" id="show-box" checked>
                        Show Bounding Box
                    </label>
                    <label>
                        <input type="checkbox" id="show-excited" checked>
                        Highlight Voltage
                    </label>
                    <label id="show-partition-label" style="display: none;">
                        <input type="checkbox" id="show-partition">
                        Show MPI Partition
                    </label>
                    <label class="colormap-label">
                        Colormap:
                        <select id="colormap-selector" class="colormap-dropdown">
                            <option value="coolwarm">Cool to Warm</option>
                            <option value="viridis">Viridis</option>
                            <option value="plasma">Plasma</option>
                            <option value="inferno">Inferno</option>
                            <option value="turbo">Turbo</option>
                            <option value="jet">Jet (Rainbow)</option>
                            <option value="grayscale">Grayscale</option>
                        </select>
                    </label>
                </div>
                <!-- Rank legend (shown when partition view is active) -->
                <div id="rank-legend" style="display: none;">
                    <span class="rank-legend-title">MPI Ranks:</span>
                    <div id="rank-legend-items"></div>
                </div>
                <!-- Partition controls (shown when partition view is active) -->
                <div id="partition-controls" style="display: none;">
                    <label>
                        <input type="checkbox" id="show-ecs">
                        Show ECS
                    </label>
                    <label>
                        <input type="checkbox" id="show-interfaces">
                        Show Interfaces
                    </label>
                    <!-- Interface type toggles (shown when interfaces are visible) -->
                    <div id="interface-type-controls" style="display: none; margin-left: 20px; margin-top: 5px;">
                        <label style="display: inline-block; margin-right: 10px;">
                            <input type="checkbox" id="show-interface-vertices" checked>
                            Vertices
                        </label>
                        <label style="display: inline-block; margin-right: 10px;">
                            <input type="checkbox" id="show-interface-edges" checked>
                            Edges
                        </label>
                        <label style="display: inline-block;">
                            <input type="checkbox" id="show-interface-faces" checked>
                            Faces
                        </label>
                    </div>
                    <label class="slider-label">
                        Explosion:
                        <input type="range" id="explosion-slider" class="slider" min="0" max="2" step="0.05" value="0" style="width: 120px;">
                        <span id="explosion-value">0</span>
                    </label>
                </div>
                <!-- Rank selector (shown when partition view is active) -->
                <div id="rank-selector" style="display: none;">
                    <span class="rank-selector-title">Show Ranks:</span>
                    <div id="rank-checkboxes"></div>
                    <button id="select-all-ranks" class="btn-small">All</button>
                    <button id="select-no-ranks" class="btn-small">None</button>
                </div>
                <!-- Iterations Chart -->
                <div id="iterations-chart-container" style="display: none;">
                    <canvas id="iterations-chart"></canvas>
                </div>
                <!-- Residual Chart -->
                <div id="residual-chart-container" style="display: none;">
                    <canvas id="residual-chart"></canvas>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <!-- Mesh Selection -->
                <section class="section">
                    <h2>Mesh Selection</h2>
                    <div class="param-row">
                        <label>Mesh file:</label>
                        <select id="mesh-selector" class="mesh-dropdown">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div id="mesh-status" class="mesh-status"></div>
                    <button id="convert-mesh" class="btn btn-secondary" style="display:none; width: 100%; margin-top: 8px;">
                        Convert Mesh
                    </button>
                    <div id="conversion-progress" class="progress-bar" style="display:none; margin-top: 8px;">
                        <div class="progress-fill"></div>
                        <span class="progress-text">0%</span>
                    </div>
                </section>

                <!-- Simulation Parameters -->
                <section class="section">
                    <h2>Simulation Parameters</h2>

                    <div class="param-row">
                        <label>Boundary Cond.:</label>
                        <select id="bc-type" class="mesh-dropdown">
                            <option value="one_corner">One corner (grounded)</option>
                            <option value="all_corners">All 8 corners</option>
                            <option value="all_boundary">All boundary DOFs</option>
                            <option value="none">Pure Neumann</option>
                        </select>
                    </div>

                    <div class="param-row">
                        <label>Time step (dt):</label>
                        <input type="number" id="dt" value="0.001" step="0.0001" min="0.0001" max="0.1">
                        <span class="unit">ms</span>
                    </div>

                    <div class="param-row">
                        <label>Number of steps:</label>
                        <input type="number" id="time-steps" value="1000" step="100" min="10" max="10000">
                    </div>

                    <div class="param-row">
                        <label>Total time:</label>
                        <span id="total-time">1.0</span>
                        <span class="unit">ms</span>
                    </div>

                    <div class="param-row">
                        <label>MPI Ranks:</label>
                        <input type="number" id="mpi-ranks" value="8" min="1" max="32" step="1">
                        <span class="unit" id="cpu-info"></span>
                    </div>

                    <div class="param-row">
                        <label>Partitioning:</label>
                        <select id="partition-mode" class="mesh-dropdown">
                            <option value="default">Default</option>
                            <option value="component">Tag based</option>
                        </select>
                    </div>
                </section>

                <!-- Solver Configuration -->
                <section class="section">
                    <h2>Solver Settings</h2>

                    <div class="param-row">
                        <label>Backend:</label>
                        <select id="solver-backend" class="mesh-dropdown">
                            <option value="petsc">PETSc</option>
                            <option value="ginkgo">Ginkgo (GPU)</option>
                        </select>
                    </div>

                    <!-- PETSc Options -->
                    <div id="petsc-options">
                        <div class="param-row">
                            <label>Solver:</label>
                            <select id="petsc-ksp-type" class="mesh-dropdown">
                                <option value="preonly">Direct (LU)</option>
                                <option value="cg">CG</option>
                                <option value="gmres">GMRES</option>
                                <option value="bicg">BiCG</option>
                            </select>
                        </div>
                        <div class="param-row" id="petsc-pc-row">
                            <label>Preconditioner:</label>
                            <select id="petsc-pc-type" class="mesh-dropdown">
                                <option value="lu">LU (MUMPS)</option>
                                <option value="hypre">Hypre AMG</option>
                                <option value="jacobi">Jacobi</option>
                                <option value="sor">SOR</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ginkgo Options -->
                    <div id="ginkgo-options" style="display: none;">
                        <div class="param-row">
                            <label>Native Assembly:</label>
                            <input type="checkbox" id="ginkgo-native-assembly" checked>
                            <span class="checkbox-label">Bypass PETSc matrix</span>
                        </div>
                        <div class="param-row" id="dd-matrix-row">
                            <label>DD Matrix:</label>
                            <input type="checkbox" id="ginkgo-dd-matrix">
                            <span class="checkbox-label">Domain decomposition format</span>
                        </div>
                        <div class="param-row">
                            <label>Compute:</label>
                            <select id="ginkgo-backend" class="mesh-dropdown">
                                <option value="omp">OpenMP (CPU)</option>
                                <option value="cuda">CUDA (GPU)</option>
                                <option value="hip">HIP (AMD GPU)</option>
                                <option value="reference">Reference</option>
                            </select>
                        </div>
                        <div class="param-row">
                            <label>Solver:</label>
                            <select id="ginkgo-solver" class="mesh-dropdown">
                                <option value="cg">CG</option>
                                <option value="fcg">Flexible CG</option>
                                <option value="gmres">GMRES</option>
                                <option value="bicgstab">BiCGSTAB</option>
                                <option value="cgs">CGS</option>
                            </select>
                        </div>
                        <div class="param-row">
                            <label>Preconditioner:</label>
                            <select id="ginkgo-precond" class="mesh-dropdown">
                                <option value="jacobi">Jacobi</option>
                                <option value="amg">AMG (Multigrid)</option>
                                <option value="block_jacobi">Block Jacobi</option>
                                <option value="ilu">ILU</option>
                                <option value="ic">IC</option>
                                <option value="isai">ISAI</option>
                                <option value="bddc">BDDC (DD only)</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <!-- AMG Options -->
                        <div id="amg-options" style="display: none;">
                            <div class="param-row">
                                <label>AMG Cycle:</label>
                                <select id="amg-cycle" class="mesh-dropdown">
                                    <option value="v">V-cycle</option>
                                    <option value="w">W-cycle</option>
                                    <option value="f">F-cycle</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Smoother:</label>
                                <select id="amg-smoother" class="mesh-dropdown">
                                    <option value="jacobi">Jacobi</option>
                                    <option value="gauss_seidel">Gauss-Seidel</option>
                                    <option value="ilu">ILU</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Max levels:</label>
                                <input type="number" id="amg-max-levels" value="10" min="2" max="20" step="1">
                            </div>
                        </div>
                        <!-- BDDC Options -->
                        <div id="bddc-options" style="display: none;">
                            <div class="param-row">
                                <label>Local Solver:</label>
                                <select id="bddc-local-solver" class="mesh-dropdown">
                                    <option value="direct">Direct (Cholesky)</option>
                                    <option value="ilu">ILU</option>
                                    <option value="ic">IC</option>
                                    <option value="amg">AMG</option>
                                </select>
                            </div>
                            <!-- Local solver stopping criteria (shown for iterative solvers: ILU, IC, AMG) -->
                            <div id="bddc-local-stopping-options" style="display: none;">
                                <div class="param-row">
                                    <label>Local Max Iter:</label>
                                    <input type="number" id="bddc-local-max-iter" value="100" min="1" max="10000" step="10">
                                </div>
                                <div class="param-row">
                                    <label>Local Tolerance:</label>
                                    <input type="text" id="bddc-local-tolerance" value="1e-12" style="width: 80px;">
                                </div>
                            </div>
                            <!-- Local AMG Options (shown when AMG is selected as local solver) -->
                            <div id="bddc-local-amg-options" style="display: none; margin-left: 10px; border-left: 2px solid #444; padding-left: 10px;">
                                <div class="param-row">
                                    <label>Smoother:</label>
                                    <select id="bddc-local-amg-smoother" class="mesh-dropdown">
                                        <option value="jacobi">Jacobi</option>
                                        <option value="gauss_seidel">Gauss-Seidel</option>
                                        <option value="ilu">ILU</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label>Smooth steps:</label>
                                    <input type="number" id="bddc-local-amg-smooth-steps" value="1" min="1" max="5" step="1">
                                </div>
                                <div class="param-row">
                                    <label>Max levels:</label>
                                    <input type="number" id="bddc-local-amg-max-levels" value="10" min="2" max="20" step="1">
                                </div>
                                <div class="param-row">
                                    <label>Coarsest Solver:</label>
                                    <select id="bddc-local-amg-coarse-solver" class="mesh-dropdown">
                                        <option value="direct">Direct</option>
                                        <option value="cg">CG</option>
                                        <option value="gmres">GMRES</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label>Relaxation:</label>
                                    <input type="number" id="bddc-local-amg-relaxation" value="0.9" min="0.1" max="1.0" step="0.05">
                                </div>
                            </div>
                            <div class="param-row">
                                <label>Coarse Solver:</label>
                                <select id="bddc-coarse-solver" class="mesh-dropdown">
                                    <option value="cg">CG</option>
                                    <option value="gmres">GMRES</option>
                                    <option value="bddc">BDDC (nested)</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Coarse Max Iter:</label>
                                <input type="number" id="bddc-coarse-max-iter" value="100" min="10" max="1000" step="10">
                            </div>
                            <!-- Coarse BDDC Local Solver (shown when BDDC is selected as coarse solver) -->
                            <div id="bddc-coarse-bddc-options" class="param-row" style="display: none;">
                                <label>Coarse BDDC Local:</label>
                                <select id="bddc-coarse-bddc-local-solver" class="mesh-dropdown">
                                    <option value="direct">Direct</option>
                                    <option value="ilu">ILU</option>
                                    <option value="ic">IC</option>
                                    <option value="amg">AMG</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>
                                    <input type="checkbox" id="bddc-vertices" checked>
                                    Vertex constraints
                                </label>
                            </div>
                            <div class="param-row">
                                <label>
                                    <input type="checkbox" id="bddc-edges" checked>
                                    Edge constraints
                                </label>
                            </div>
                            <div class="param-row">
                                <label>
                                    <input type="checkbox" id="bddc-faces" checked>
                                    Face constraints
                                </label>
                            </div>
                            <div class="param-row">
                                <label>
                                    <input type="checkbox" id="bddc-repartition-coarse" checked>
                                    Repartition coarse problem
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="param-row">
                        <label>Rel. tol.:</label>
                        <input type="text" id="solver-rtol" value="1e-8" style="width: 80px;">
                    </div>
                    <div class="param-row">
                        <label>Abs. tol.:</label>
                        <input type="text" id="solver-atol" value="1e-12" style="width: 80px;">
                    </div>
                    <div class="param-row">
                        <label>Max iter.:</label>
                        <input type="number" id="solver-max-iter" value="1000" min="10" max="10000" step="100" style="width: 80px;">
                    </div>
                </section>

                <!-- Bounding Box Controls -->
                <section class="section">
                    <h2>Excitation Bounding Box (um)</h2>
                    <p class="hint">Region inside box starts depolarized</p>

                    <div class="slider-group">
                        <label>X Range</label>
                        <div class="dual-slider">
                            <input type="range" id="x-min" class="slider">
                            <input type="range" id="x-max" class="slider">
                        </div>
                        <div class="slider-values">
                            <span id="x-min-val">-62</span> to <span id="x-max-val">15</span> um
                        </div>
                    </div>

                    <div class="slider-group">
                        <label>Y Range</label>
                        <div class="dual-slider">
                            <input type="range" id="y-min" class="slider">
                            <input type="range" id="y-max" class="slider">
                        </div>
                        <div class="slider-values">
                            <span id="y-min-val">-19</span> to <span id="y-max-val">68</span> um
                        </div>
                    </div>

                    <div class="slider-group">
                        <label>Z Range</label>
                        <div class="dual-slider">
                            <input type="range" id="z-min" class="slider">
                            <input type="range" id="z-max" class="slider">
                        </div>
                        <div class="slider-values">
                            <span id="z-min-val">-20</span> to <span id="z-max-val">118</span> um
                        </div>
                    </div>
                </section>

                <!-- Excitation Strength -->
                <section class="section">
                    <h2>Initial Voltage (mV)</h2>

                    <div class="slider-group">
                        <label>Excited region: <span id="v-excited-val">0</span> mV</label>
                        <input type="range" id="v-excited" class="slider" min="-40" max="40" value="0" step="1">
                    </div>

                    <div class="slider-group">
                        <label>Resting region: <span id="v-resting-val">-80</span> mV</label>
                        <input type="range" id="v-resting" class="slider" min="-100" max="-40" value="-80" step="1">
                    </div>
                </section>

                <!-- Generated Expression Preview -->
                <section class="section">
                    <h2>Generated v_init Expression</h2>
                    <pre id="v-init-preview" class="code-preview"></pre>
                </section>

                <!-- Actions -->
                <section class="section actions">
                    <button id="run-simulation" class="btn btn-success">
                        Run Simulation
                    </button>
                    <button id="cancel-simulation" class="btn btn-danger" style="display: none;">
                        Cancel
                    </button>
                </section>

                <!-- Simulation Output -->
                <section class="section">
                    <h2>Simulation Output</h2>
                    <div id="simulation-status" class="status"></div>
                    <pre id="simulation-output" class="output-console"></pre>
                </section>

                <!-- Results Visualization -->
                <section class="section" id="results-section">
                    <h2>Results Visualization</h2>
                    <div class="param-row">
                        <label>Simulation:</label>
                        <select id="simulation-selector" class="mesh-dropdown">
                            <option value="">Select simulation...</option>
                        </select>
                    </div>
                    <div class="param-row">
                        <label>Time:</label>
                        <input type="range" id="result-time" class="slider" min="0" max="100" value="0">
                        <span id="result-time-val">0.0</span>
                        <span class="unit">ms</span>
                    </div>
                    <div class="param-row">
                        <label>V range:</label>
                        <span id="v-min-result">-80</span> to <span id="v-max-result">40</span> mV
                    </div>
                    <div class="param-row">
                        <label>
                            <input type="checkbox" id="regenerate-viz">
                            Regenerate viz data
                        </label>
                    </div>
                    <button id="load-results" class="btn btn-primary" style="width: 100%;">
                        Load Results
                    </button>
                    <div id="results-status" class="mesh-status" style="display:none;"></div>
                </section>

                <!-- Video Export -->
                <section class="section" id="video-export-section">
                    <h2>Video Export</h2>
                    <div class="param-row">
                        <label>Resolution:</label>
                        <select id="video-resolution" class="mesh-dropdown">
                            <option value="1280x720">720p (1280x720)</option>
                            <option value="1920x1080" selected>1080p (1920x1080)</option>
                            <option value="2560x1440">1440p (2560x1440)</option>
                        </select>
                    </div>
                    <div class="param-row">
                        <label>Frame rate:</label>
                        <input type="number" id="video-fps" value="30" min="10" max="60" step="5">
                        <span class="unit">fps</span>
                    </div>
                    <button id="export-video" class="btn btn-primary" style="width: 100%;">
                        Export Video
                    </button>
                    <div id="video-progress" class="progress-bar" style="display:none; margin-top: 8px;">
                        <div class="progress-fill"></div>
                        <span class="progress-text">0%</span>
                    </div>
                    <div id="video-status" class="mesh-status" style="display:none;"></div>
                    <a id="video-download" href="#" class="btn btn-success" style="display:none; width: 100%; text-align: center; margin-top: 8px; text-decoration: none;">
                        Download Video
                    </a>
                </section>
            </div>
        </div>
    </div>

    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Application -->
    <script src="js/mesh-loader.js"></script>
    <script src="js/viewer.js"></script>
    <script src="js/config-manager.js"></script>
    <script src="js/simulation-runner.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
